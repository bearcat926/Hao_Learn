# 2019.8.14

## ElasticSearch 安装报错整理

#### 单机安装报错

**初次启动服务**

当使用root账户调用启动命令出现错误信息，错误提示信息如下：

```
[2017-08-30T13:32:17,003][WARN ][o.e.b.ElasticsearchUncaughtExceptionHandler] [ELK-node1] uncaught exception in thread [main]
org.elasticsearch.bootstrap.StartupException: java.lang.RuntimeException: can not run elasticsearch as root
    at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:127) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:114) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:67) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:122) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.cli.Command.main(Command.java:88) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:91) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:84) ~[elasticsearch-5.5.2.jar:5.5.2]
Caused by: java.lang.RuntimeException: can not run elasticsearch as root
    at org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:106) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:194) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:351) ~[elasticsearch-5.5.2.jar:5.5.2]
    at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:123) ~[elasticsearch-5.5.2.jar:5.5.2]
    ... 6 more
```

**创建新用户**
由于Elasticsearch可以接收用户输入的脚本并且执行，为了系统安全考虑，不允许root账号启动，所以建议给Elasticsearch单独创建一个用户来运行Elasticsearch。
```shell
groupadd elk
#useradd [用户名] -g [所属组名] -p [密码]
useradd  elk -g elk -p elk
```

**授权访问组权限**
```shell
#chown -R [所属用户] : [所属用户组名] [要更改的文件路径]
chown -R elk : elk /opt/elasticsearch-6.8.1
chmod -R 777 /opt/elasticsearch-6.8.1
```

**授权 root 权限**
```shell
chmod 777 /etc/sudoers
vi /etc/sudoers
```
```shell
root    ALL=(ALL)       ALL

#给用户elk添加root权限，NOPASSWD即不用输密码
ymq     ALL=(ALL)       NOPASSWD:ALL 
```
```shell
pkexec chmod 0440 /etc/sudoers
su elk
/opt/elasticsearch-6.8.1/bin/elasticsearch
```

**如果报如下错误，都切换到 root 用户进项修改：**

```
[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]
```
```shell
vi /etc/security/limits.conf 

#添加如下内容
* soft nofile 65536
* hard nofile 131072
* soft nproc 2048
* hard nproc 4096
```

-------------------

```
[2]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
```
```shell
vi /etc/sysctl.conf 

#在第一行加上如下内容
vm.max_map_count = 655360

# 执行
sysctl -p
```

-------------------
```java
//异常 IllegalStateException
Caused by: java.lang.IllegalStateException: failed to obtain node locks, tried [[/opt/elasticsearch-5.5.2/data/ymq]] with lock id [0]; maybe thes
//异常 RemoteTransportException
[2017-09-01T11:40:42,115][INFO ][o.e.d.z.ZenDiscovery     ] [ELK-node2] failed to send join request to master [{ELK-node1}{DKCwxkubTFufsBaOSXj9Nw}{UIMSNeuIT6m8SFGGTi4wSg}{192.168.252.121}{192.168.252.121:9300}], reason [RemoteTransportException[[ELK-node1][192.168.252.121:9300][internal:discovery/zen/join]]; nested: NotMasterException[Node [{ELK-node1}{DKCwxkubTFufsBaOSXj9Nw}{UIMSNeuIT6m8SFGGTi4wSg}{192.168.252.121}{192.168.252.121:9300}] not master for join request]; ], tried [3] times
```
```shell
#删除安装目录下的data
cd /opt/elasticsearch-6.8.1/data
rm -rf nodes
```

--------------------------

```java
//异常 ElasticsearchUncaughtExceptionHandler
//上次启动失败，占用了端口
[2017-08-30T22:02:14,463][WARN ][o.e.b.ElasticsearchUncaughtExceptionHandler] [ELK-node2] uncaught exception in thread [main]
org.elasticsearch.bootstrap.StartupException: BindHttpException[Failed to bind to [9200]]; nested: BindException[Address already in use];
```
```shell
jps 
2824 Elasticsearch
3165 Jps

kill -9 2824
```

-----------------------

```shell
#再次启动服务
su elk
/opt/elasticsearch-6.8.1/bin/elasticsearch  -d
#或者
cd /opt/elasticsearch-6.8.1
nohup bin/elasticsearch &
```

```shell
#jvm 内存内存修改
vi /opt/elasticsearch-6.8.1/config/jvm.options

#-Xms2g  修改为512m
#-Xmx2g  修改为512m

```
```shell
# 查看日志
less /opt/elasticsearch-6.8.1/logs/elk.log

```



## Linux命令行出现出现there are stopped jobs问题
**问题介绍：**
当准备退出时，输入完logout/exit命令，出现there are stopped jobs无法退出提示。

**查看被停止的程序命令： **
输入 `jobs `，系统显示：
```shell
[1]+  Stopped                 bin/hive`
```
输入` jobs -l`，系统显示：
```shell
[1]+  5510 Stopped            bin/hive
```
原来，我开始编辑文本，习惯性按`ctrl + z`停止它了。 

**解决问题：**
1. 如果重新启动使用`fg %1`
其中%1表示第一个被停止的程序，就是**中括号中的数字**； 
2. 如果要彻底结束程序，使用`kill %1 `
这里的%1同fg命令一样，输入后，会有提示 
	

这样，再次用logout、exit就可以退出了

## Linux的压缩/解压缩文件处理 zip & unzip

```shell
#将当前目录下的所有文件和文件夹全部压缩成myfile.zip文件,－r表示递归压缩子目录下所有文件
zip -r myfile.zip ./*

#把myfile.zip文件解压到 /home/sunny/
unzip -o -d /home/sunny myfile.zip

#-o:不提示的情况下覆盖文件；
#-d:指明将文件解压缩到/home/sunny目录下；
```

## Elasticsearch 中文分词器配置

#### IK分词器

![1565774605270](E:\git_repo\Hao_Learn\2019\8\img\1565774605270.png)



